---
apiVersion: v1
kind: Namespace
metadata:
  name: ollama
---
apiVersion: "apps/v1"
kind: Deployment
metadata:
  name: ollama
  namespace: ollama
  labels:
    app: ollama
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ollama
  strategy:
    type: Recreate
  template:
    metadata:
      name: ollama
      labels:
        app: ollama
    spec:
      containers:
      - image: "ollama/ollama:0.12.10"
        name: ollama-0
        ports:
        - containerPort: 11434
          protocol: TCP
        volumeMounts:
        - mountPath: "/root/.ollama"
          name: ollama-data-volume
        resources:
          limits:
            "nvidia.com/gpu-all": "1"
          requests:
            "nvidia.com/gpu-all": "1"
      runtimeClassName: nvidia
      volumes:
      - name: ollama-data-volume
        persistentVolumeClaim:
          claimName: ollama-data
---
apiVersion: v1
kind: Service
metadata:
  name: ollama
  namespace: ollama
  labels:
    app: ollama
spec:
  selector:
    app: ollama
  ports:
  - port: 11434
    targetPort: 11434
    protocol: TCP
---
apiVersion: "apps/v1"
kind: Deployment
metadata:
  name: openwebui
  namespace: ollama
  labels:
    app: openwebui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openwebui
  strategy:
    type: Recreate
  template:
    metadata:
      name: openwebui
      labels:
        app: openwebui
    spec:
      containers:
      - image: "ghcr.io/open-webui/open-webui:main-slim"
        name: openwebui-0
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - mountPath: "/app/backend/data"
          name: openwebui-data-volume
      volumes:
      - name: openwebui-data-volume
        persistentVolumeClaim:
          claimName: openwebui-data
---
apiVersion: v1
kind: Service
metadata:
  name: openwebui
  namespace: ollama
  labels:
    app: openwebui
spec:
  selector:
    app: openwebui
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
---
apiVersion: "networking.k8s.io/v1"
kind: Ingress
metadata:
  name: openwebui
  namespace: ollama
  annotations:
    "cert-manager.io/cluster-issuer": letsencrypt-prod
    "cert-manager.io/private-key-algorithm": ECDSA
    "traefik.ingress.kubernetes.io/router.entrypoints": "web,websecure"
    "traefik.ingress.kubernetes.io/router.middlewares": "default-hsts-middleware@kubernetescrd,default-https-redirect-middleware@kubernetescrd,default-local-ipwhitelist@kubernetescrd"
spec:
  rules:
  - host: "openwebui.app.zeromap.net"
    http:
      paths:
      - path: "/"
        pathType: Prefix
        backend:
          service:
            name: openwebui
            port:
              number: 8080
  tls:
  - hosts:
    - "openwebui.app.zeromap.net"
    secretName: openwebui-cert
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ollama-data
  namespace: ollama
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: "16G"
  storageClassName: local-path
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openwebui-data
  namespace: ollama
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: "1Gi"
  storageClassName: local-path
